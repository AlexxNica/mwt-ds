@using DecisionServicePrivateWeb.Models
@{
    Layout = null;
}
@model SimulationViewModel

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title></title>

    <link rel="stylesheet" type="text/css" href="~/Content/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="~/Content/Demo.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.css">

</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top" style="background-color:black; color:white">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="@Url.Action("APIGuide", "Home")">Guide</a></li>
                    <li><a href="@Url.Action("APITestDrive", "Home")">Test Drive</a></li>
                    <li><a href="@Url.Action("APITest", "Home")">Test</a></li>
                </ul>
            </div>
        </div>
    </div>

    <br />

    <div class="section" style="width:100%;">
        <p align="center" class="lead">
            Test Drive
        </p>
        <p align="center" style="font-weight:100; margin-bottom:20px">
            Choose the reward and let the Decision Service learn your preferences
        </p>
    </div>

    <div class="input-group" style="margin: 0 auto; width:300px">
        <div class="input-group-addon" style="color:black">Authorization token: </div>
        <input type="text" class="form-control" id="userToken" placeholder="Web service token" value="@Model.WebServiceToken">
    </div>

    <br /><br />



    <div class="row">



        <!-- Left pane -->
        <div class="col-md-6" style="border-right:1px solid; margin:0 auto">

            <!-- Articles -->
            <div class="row" style="text-align: center;">
                <div class="col-md-6">
                    <div class="section" style="width:100%; margin-bottom:14px">
                        <p align="center" style="font-size:20px">
                            Context
                        </p>
                        <p align="center" style="font-weight:100">
                            Available information/features (e.g. user location)
                        </p>
                    </div>
                    <!--<div class="thumbnail" style="text-align: center; margin: 0 auto; display: table; width:200px;">
                        <div class="caption">
                            <p>Location:</p>
                            <form id="LocationForm">
                                <div class="radio" style="text-align:left">
                                    <label><input type="radio" name="optradio" checked="checked" value="Seattle" id="contextDefaultRadio">Seattle</label>
                                </div>
                                <div class="radio" style="text-align:left">
                                    <label><input type="radio" name="optradio" value="DC">Washington D.C.</label>
                                </div>
                                <div class="radio" style="text-align:left">
                                    <label><input type="radio" name="optradio" value="NYC">New York City</label>
                                </div>
                            </form>
                        </div>

                    </div>-->
                    <div class="thumbnail content-item" id="article1">
                        <div class="caption" style="padding-bottom:0px">
                            <p style="margin-bottom: 10px; margin-top: 0px;" id="locationText"></p>
                            <div style="width: 230px; height: 200px; overflow:hidden">
                                <img style="width: 230px; height: 316.8px;"
                                     id="location"
                                     src=""
                                     alt="...">
                            </div>

                        </div>
                    </div>

                </div>

                <div class="col-md-6">
                    <div class="section" style="width:100%;">
                        <p align="center" style="font-size:20px">
                            Action
                        </p>
                        <p align="center" style="font-weight:100">
                            Chosen by the Decision Service based on the context
                        </p>
                    </div>
                    <div class="thumbnail content-item" id="article2" style="width:260px">
                        <div class="caption" style="padding-bottom:0px">
                            <p style="margin-bottom: 10px; margin-top: 0px;" id="articleText">What counts as artificially intelligent? AI explained</p>
                            <div style="width: 230px; height: 200px; overflow:hidden">
                                <img style="width: 260.7px; height: 200px; margin-left:-10px"
                                     id="article"
                                     src="https://upload.wikimedia.org/wikipedia/commons/2/28/Artificial-intelligence-elon-musk-hawking.jpg"
                                     alt="...">
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <br />

            <br />
            <div class="row">
                <div class="col-md-6" style="text-align: right;">
                    <a style="font-family:'Segoe UI'; font-size:120px; text-decoration:none" href="javascript:reportReward(1);">&#x1F44D</a> &nbsp;
                    <br /><p style="padding-right:20px">(or press '1')</p>
                </div>
                <div class="col-md-6" style="text-align: left;">
                    <a style="font-family:'Segoe UI'; font-size:120px; text-decoration:none" href="javascript:reportReward(-2);">&#x1F44E</a> &nbsp;
                    <br /><p>(or press '0')</p>
                </div>
            </div>
            <br />
            <div style="text-align:center">
                Time until next decision: <div id="timer">10 seconds left</div>
            </div>

            <br />
            <div style="text-align:center;">
                <div style="margin-bottom:15px" id="status"></div>
                <div style="margin-bottom:15px" id="statusModel">Latest model: </div>
                <div style="margin-bottom:15px" id="statusReward"></div>
                <button onclick="resetModel()" class="btn btn-primary btn-group-sm">Reset Model</button>
            </div>



        </div>

        <!-- Right pane -->
        <div class="col-md-6">
            <div class="row">
                <div class="input-group" style="margin: 0 auto; width:300px">
                    <div class="input-group-addon" style="color:black">Show results for the past: </div>

                    <div class="col-sm-10" style="padding-left:0px">
                        @Html.DropDownList("eval-window-filter",
                    Model.EvaluationView.WindowFilters.Select(m => new SelectListItem
                    {
                        Value = m,
                        Text = m,
                        Selected = (m == Model.EvaluationView.SelectedFilter)
                    }),
                    new { @id = "eval-window-filter", @class = "form-control", @style = "display:inline" })
                    </div>

                </div>


            </div>
            <label for="eval-window-filter" class="col-sm-2 control-label ds-label" style="max-width: 280px;"></label>
            <br /><br />
            <div class="thumbnail" style="text-align:center; width:650px; margin: 0 auto">
                <div class="caption article">
                    <div id="chart-api">
                        <svg style="height: 500px;"></svg>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <script type="text/javascript" src="/scripts/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/scripts/bootstrap.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="/scripts/eval.js"></script>

    <script>
        var locations = [
            {
                key: "NYC",
                text: "New York City",
                image:"https://upload.wikimedia.org/wikipedia/commons/9/9d/NYC_Montage_2014_4_-_Jleon.jpg"
            },
            {
                key: "Seattle",
                text: "Seattle",
                image:"https://upload.wikimedia.org/wikipedia/commons/2/2f/Space_Needle002.jpg"
            }
        ];

        var actions = [
            {
                text: "What counts as artificially intelligent? AI explained",
                image: "https://upload.wikimedia.org/wikipedia/commons/2/28/Artificial-intelligence-elon-musk-hawking.jpg",
                imgStyle: "width: 260.7px; height: 200px; margin-left:-10px"
            },
            {
                text: "Why the Federal Reserve isn't out of options yet",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8d/Marriner_S._Eccles_Federal_Reserve_Board_Building.jpg/1280px-Marriner_S._Eccles_Federal_Reserve_Board_Building.jpg",
                imgStyle: "width: 360px; height: 200px; overflow:hidden; margin-left:-60px"
            }
        ];

        var secondsLeft = 10;
        var locationIndex = 0;
        var eventId;

        function chooseAction() {
            locationIndex = (locationIndex + 1) % locations.length;
            $("#location").attr("src", locations[locationIndex].image);
            $("#locationText").text(locations[locationIndex].text);
            //$("#article").attr("src", "");

            secondsLeft = 10;

            var context = { "Location": locations[locationIndex].key };
            // Get Decision
            $.ajax({
                method: "POST",
                url: "/API/Policy",
                data: JSON.stringify(context),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                headers: {
                    "auth": $("#userToken").val()
                },
            })
            .done(function (data) {
                eventId = data.EventId;
                modelTime = data.ModelTime;
                $("#article").attr("src", actions[data.Action - 1].image);
                $("#article").attr("style", actions[data.Action - 1].imgStyle);
                $("#articleText").text(actions[data.Action - 1].text);
                $("#statusModel").text('Latest model: ' + new Date(parseInt(modelTime.substr(6))));
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                $("#status").text("Error: " + textStatus + "  " + errorThrown);
            });
        };
        chooseAction();

        setInterval(function () {
            if ($("#userToken").val().length == 0)
            {
                $("#timer").text("Set userToken");
                return;
            }

            $("#timer").text(secondsLeft + " seconds left");
            secondsLeft--;

            if (secondsLeft < 0)
                chooseAction();
            }, 1000);

        function reportReward(reward) {
            var thisEventId = eventId;

            $.ajax({
                method: "POST",
                url: "/API/Reward/?eventId=" + eventId,
                data: "" + reward,
                headers: {
                    "auth": $("#userToken").val()
                },
            })
            .done(function (data) {
                $("#statusReward").text("Success. Event ID: " + thisEventId + " and reward: " + reward);
                chooseAction();
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                $("#status").text("Error: " + textStatus + "  " + errorThrown);
            });
        }

        function resetModel() {
            $.ajax({
                method: "POST",
                url: "/API/reset",
                headers: {
                    "auth": "@Model.TrainerToken"
                },
            })
            .done(function (data) {
                $("#statusReward").text("Successfully reset.");
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                $("#status").text("Error: " + textStatus + "  " + errorThrown);
            });
        }

        $(document).keydown(function (e) {
            switch (e.which)
            {
                case 49: // '1' // 38: // up
                    reportReward(1);
                    break;
                case 48: // '0' // 40: // down
                    reportReward(-2);
                    break;
            }
        });

        /*
        $('#LocationForm input').on('change', function () {
            chooseAction();
        });
        */
    </script>
</body>
</html>
