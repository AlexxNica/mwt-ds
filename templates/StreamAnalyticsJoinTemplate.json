{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "UserStorageAccountName": { "type": "string" },
    "UserStorageAccountKey": { "type": "string" },
    "SystemStorageBaseUri": { "type": "string" },
    "serviceBusName": { "type": "string" },

    "messageRetentionInDays": { "type": "int" },
    "partitionCount": { "type": "int" },

    "joinQuery": {
      "type": "string",
      "defaultValue": ""
    },
    "joinEventsLateArrivalMaxDelayInSeconds": { "type": "int" },

    "streamingUnits": {
      "type": "int",
      "defaultValue": 1
    }
  },
  "resources": [
    { // Interaction Event Hub (input)
      "apiVersion": "2015-01-01",
      "name": "interaction",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('SystemStorageBaseUri'), '/templates/EventHubTemplate.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "ehName": { "value": "interaction" },
          "serviceBusName": { "value": "[parameters('serviceBusName')]" },
          "messageRetentionInDays": { "value": "[parameters('messageRetentionInDays')]" },
          "partitionCount": { "value": "[parameters('partitionCount')]" }
        }
      }
    },
    { // Observation Event Hub (input)
      "apiVersion": "2015-01-01",
      "name": "observation",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('SystemStorageBaseUri'), '/templates/EventHubTemplate.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "ehName": { "value": "observation" },
          "serviceBusName": { "value": "[parameters('serviceBusName')]" },
          "messageRetentionInDays": { "value": "[parameters('messageRetentionInDays')]" },
          "partitionCount": { "value": "[parameters('partitionCount')]" }
        }
      }
    },
    { // Joined Event Hub (output)
      "apiVersion": "2015-01-01",
      "name": "joined",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "[concat(parameters('SystemStorageBaseUri'), '/templates/EventHubTemplate.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "ehName": { "value": "joined" },
          "serviceBusName": { "value": "[parameters('serviceBusName')]" },
          "messageRetentionInDays": { "value": "[parameters('messageRetentionInDays')]" },
          "partitionCount": { "value": "[parameters('partitionCount')]" }
        }
      }
    },
    {
      "apiVersion": "2015-10-01",
      "type": "Microsoft.StreamAnalytics/streamingjobs",
      "name": "[concat(resourceGroup().name, '-join')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "Microsoft.Resources/deployments/interaction",
        "Microsoft.Resources/deployments/observation",
        "Microsoft.Resources/deployments/joined"
      ],
      "properties": {
        "sku": {
          "name": "standard"
        },
        "OutputStartMode": "JobStartTime",
        "EventsOutOfOrderMaxDelayInSeconds": 0,
        "EventsLateArrivalMaxDelayInSeconds": "[parameters('joinEventsLateArrivalMaxDelayInSeconds')]",
        "EventsOutOfOrderPolicy": "adjust",
        "Inputs": [
          {
            "Name": "interaction",
            "Properties": {
              "DataSource": {
                "Properties": {
                  "ServiceBusNamespace": "[parameters('serviceBusName')]",
                  "eventHubName": "interaction",
                  "sharedAccessPolicyName": "ListenOnly",
                  "sharedAccessPolicyKey": "[reference('Microsoft.Resources/deployments/interaction', '2015-01-01').outputs.ListenKey.value]"
                },
                "Type": "Microsoft.ServiceBus/EventHub"
              },
              "Serialization": {
                "Properties": {
                  "Encoding": "UTF8"
                },
                "Type": "Json"
              },
              "Type": "Stream"
            }
          },
          {
            "Name": "observation",
            "Properties": {
              "DataSource": {
                "Properties": {
                  "ServiceBusNamespace": "[parameters('serviceBusName')]",
                  "eventHubName": "observation",
                  "sharedAccessPolicyName": "ListenOnly",
                  "sharedAccessPolicyKey": "[reference('Microsoft.Resources/deployments/observation', '2015-01-01').outputs.ListenKey.value]"
                },
                "Type": "Microsoft.ServiceBus/EventHub"
              },
              "Serialization": {
                "Properties": {
                  "Encoding": "UTF8"
                },
                "Type": "Json"
              },
              "Type": "Stream"
            }
          }
        ],
        "Outputs": [
          {
            "Name": "outHubStream",
            "Properties": {
              "DataSource": {
                "Properties": {
                  "ServiceBusNamespace": "[parameters('serviceBusName')]",
                  "eventHubName": "joined",
                  "sharedAccessPolicyName": "SendOnly",
                  "sharedAccessPolicyKey": "[reference('Microsoft.Resources/deployments/joined', '2015-01-01').outputs.SendKey.value]"
                },
                "Type": "Microsoft.ServiceBus/EventHub"
              },
              "Serialization": {
                "Properties": {
                  "Encoding": "UTF8"
                },
                "Type": "Json"
              },
              "Type": "Stream"
            }
          },
          { // extra output for diagnostics
            "Name": "outBlob",
            "Properties": {
              "DataSource": {
                "Properties": {
                  "Container": "joined-examples",
                  "DateFormat": "yyyy/MM/dd",
                  "TimeFormat": "HH",
                  "PathPattern": "{date}/{time}",
                  "StorageAccounts": [
                    {
                      "AccountName": "[parameters('UserStorageAccountName')]",
                      "AccountKey": "[parameters('UserStorageAccountKey')]"
                    }
                  ]
                },
                "Type": "Microsoft.Storage/Blob"
              },
              "Serialization": {
                "Properties": {
                  "Encoding": "UTF8"
                },
                "Type": "Json"
              }
            }
          }
        ],
        "Transformation": {
          "Name": "theJoinQuery",
          "Properties": {
            "Query": "[parameters('joinQuery')]",
            "StreamingUnits": "[parameters('streamingUnits')]"
          }
        }
      }
    }
  ],
  "outputs": {
    "InteractionEventHubSendConnectionString": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Resources/deployments/interaction'), '2015-01-01').outputs.SendConnectionString.value]"
    },
    "InteractionEventHubSendKey": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Resources/deployments/interaction'), '2015-01-01').outputs.SendKey.value]"
    },
    "ObservationEventHubSendConnectionString": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Resources/deployments/observation'), '2015-01-01').outputs.SendConnectionString.value]"
    },
    "ObservationEventHubSendKey": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Resources/deployments/observation'), '2015-01-01').outputs.SendKey.value]"
    },
    "JoinedEventHubListenConnectionString": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Resources/deployments/joined'), '2015-01-01').outputs.ListenConnectionString.value]"
    },
    "JoinedEventHubListenKey": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Resources/deployments/joined'), '2015-01-01').outputs.ListenKey.value]"
    }
  }
}
